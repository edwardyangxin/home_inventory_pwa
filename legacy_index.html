<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <title>Web Speech Demo</title>
  <style>
    body { font-family: sans-serif; padding: 20px; }
    #output {
      border: 1px solid #ccc;
      padding: 10px;
      min-height: 100px;
      margin-top: 10px;
      white-space: pre-wrap;
    }
    button { padding: 10px 20px; margin-right: 10px; cursor: pointer; }
    .status { color: #666; font-size: 0.9em; margin-top: 5px; }
  </style>
</head>
<body>
  <h2>ğŸ™ è¯­éŸ³è¾“å…¥ï¼ˆæœ¬åœ° STTï¼‰</h2>
  <button id="start">å¼€å§‹å½•éŸ³</button>
  <button id="stop" disabled>ç»“æŸå½•éŸ³</button>
  <div id="status" class="status">å‡†å¤‡å°±ç»ª</div>
  <div id="output"></div>

  <script>
    const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;

    if (!SpeechRecognition) {
      alert("å½“å‰æµè§ˆå™¨ä¸æ”¯æŒ Web Speech API");
    } else {
      const recognition = new SpeechRecognition();
      recognition.lang = "zh-CN";
      recognition.continuous = true;
      recognition.interimResults = true;

      const outputDiv = document.getElementById("output");
      const statusDiv = document.getElementById("status");
      const startBtn = document.getElementById("start");
      const stopBtn = document.getElementById("stop");

      let autoStopTimer = null;
      let finalTranscript = "";

      recognition.onstart = () => {
        statusDiv.innerText = "æ­£åœ¨å½•éŸ³... (30ç§’åè‡ªåŠ¨ç»“æŸ)";
        startBtn.disabled = true;
        stopBtn.disabled = false;
        finalTranscript = ""; // æ¸…ç©ºä¹‹å‰çš„è®°å½•
        outputDiv.innerText = "";

        // 4. å¦‚æœå¼€å§‹äº†30sï¼Œè‡ªåŠ¨ç»“æŸå½•éŸ³ã€‚
        autoStopTimer = setTimeout(() => {
          if (recognition) {
            console.log("30s timeout reached, stopping...");
            recognition.stop();
            statusDiv.innerText = "å·²åœæ­¢ (è¶…æ—¶)";
          }
        }, 30000);
      };

      recognition.onresult = (event) => {
        let interimTranscript = "";

        for (let i = event.resultIndex; i < event.results.length; ++i) {
          const transcript = event.results[i][0].transcript;
          if (event.results[i].isFinal) {
            finalTranscript += transcript;
          } else {
            interimTranscript += transcript;
          }
        }

        // 3. å¦‚æœæˆ‘è¯´äº†overï¼Œä¹Ÿç»“æŸã€‚
        // Check both final and interim for "over"
        const combinedText = finalTranscript + interimTranscript;
        if (combinedText.toLowerCase().includes("over")) {
            console.log("Keyword 'over' detected, stopping...");
            recognition.stop();
            statusDiv.innerText = "å·²åœæ­¢ (æ£€æµ‹åˆ° 'over')";
        }

        outputDiv.innerText = finalTranscript + interimTranscript;
      };

      recognition.onend = () => {
        startBtn.disabled = false;
        stopBtn.disabled = true;
        clearTimeout(autoStopTimer);
        
        if (finalTranscript || outputDiv.innerText) {
            statusDiv.innerText = "å½•éŸ³ç»“æŸï¼Œæ­£åœ¨ä¸Šä¼ åˆ° API...";
            // Simulate API post delay
            mockPostToAPI(finalTranscript || outputDiv.innerText).then(response => {
                outputDiv.innerText += "\n\n[API å“åº”]: " + response;
                statusDiv.innerText = "å¤„ç†å®Œæˆ";
            });
        } else {
            statusDiv.innerText = "å½•éŸ³ç»“æŸ (æ— å†…å®¹)";
        }
      };

      recognition.onerror = (event) => {
        console.error("Speech recognition error", event.error);
        statusDiv.innerText = "å‘ç”Ÿé”™è¯¯: " + event.error;
        startBtn.disabled = false;
        stopBtn.disabled = true;
        clearTimeout(autoStopTimer);
      };

      // Mock API Post Function
      function mockPostToAPI(text) {
        return new Promise(resolve => {
            console.log("Posting text to API:", text);
            setTimeout(() => {
                // Simulating a success response from a backend
                resolve("æˆåŠŸæ¥æ”¶æ–‡æœ¬ï¼Œå­—ç¬¦é•¿åº¦: " + text.length);
            }, 1500);
        });
      }

      // 1. æˆ‘ç‚¹å¼€å½•éŸ³ï¼Œå¼€å§‹è®°å½•
      startBtn.onclick = () => {
        try {
          recognition.start();
        } catch (e) {
          console.error(e);
        }
      };

      // 2. æˆ‘ç‚¹å‡»ç»“æŸï¼Œå¼€å§‹ç¿»è¯‘(æ˜¾ç¤ºæ–‡å­—)
      stopBtn.onclick = () => {
        recognition.stop();
        statusDiv.innerText = "å·²æ‰‹åŠ¨åœæ­¢";
      };
    }
  </script>
</body>
</html>
